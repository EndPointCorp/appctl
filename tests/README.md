### Installation, tests setup
  
There are 3 kinds of tests available to run.

* Chrome - Selenium type tests
* ROS Chrome - All Selenium type tets + Selenium ROS tests
* Catkin - pure ROS unit tests

#### ROS installation


```
sudo sh -c 'echo "deb http://packages.ros.org/ros/ubuntu trusty main" > /etc/apt/sources.list.d/ros-latest.list'
wget https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -O - | sudo apt-key add -
sudo apt-get update
sudo apt-get install ros-indigo-ros-base ros-indigo-rosbridge-server ros-indigo-geographic-msgs
```

Then:

- modify /etc/hosts so 42-b is pointing to localhost
- manage SSL for secure websocket connection
- install package that provides certutil
```
sudo apt-get install libnss3-tools
```

- generate the ssl key and import it to browser's nssdb
```
./catkin/src/portal/launch/bin/manage_ssl.sh
```

- add following line to ~/.bashrc for convenience
```
if [ -f /opt/ros/indigo/setup.bash ] ; then
    . /opt/ros/indigo/setup.bash
fi
```

- following commands are run just once or if something changes in the catkin workspace
```
cd catkin
catkin_make
```

- leap_motion if catkin_make complains about leap_motion, the package handled in a
separate repository needs to be cloned and re-run catkin_make step:
```
cd catkin/src
git clone https://github.com/EndPointCorp/leap_motion.git
cd ..
```

See https://github.com/EndPointCorp/lg_chef/blob/master/cookbooks/lg_ci/files/default/run_tests_local.sh
for reference.

- onboard test depends on an external onboard system application, python binding and
handling of the process by the tests is transparent, just:
```
sudo apt-get install onboard
```

onboard ROS node configuration, which is normally handled by lg-live-image is put
under catkin/src/portal/launch/onboard.dconf for testing and development.

 
#### Python Packages

```
pip install --user -r tests/requirements.txt
```

#### Chrome

```
wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
sudo sh -c 'echo "deb http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
sudo apt-get update
sudo apt-get install google-chrome-stable
```

#### Chromedriver

Install the latest version of chromedriver.

<http://chromedriver.storage.googleapis.com/index.html>


#### Xfvb

```
sudo apt-get install xvfb
```

For the headless tests we need to have the xvfb running. This can be achieved with a command:

```
sudo Xvfb :10 -ac
```

To verify that your Xvfb can run Chrome:

```
DISPLAY=:10 google-chrome
```

### Running tests

#### Chrome extensions tests

The test suite is configured via a JSON configuration file. See `config-example.json` template
for guidance when creating one. The valid config.json can live anywhere, the env
variable `PORTAL_TESTS_CONFIG` need to point to it, the test suite fails otherwise.

Run the tests from the main project directory:

```
py.test
py.test tests/extensions/functional/ to speed up discovery
py.test -s  # to see stdout
py.test -k test_url_change_after_search  # to run only 1 particular test case
```

#### ROS enabled chrome tests

Like above, need to have `PORTAL_TESTS_CONFIG` variable set and pointing
to the JSON config file.

Build and launch ROS nodes. Everything run from the project directory.


Run in one terminal:

```
source catkin/devel/setup.bash
roslaunch catkin/src/portal/launch/portal.launch
```

Run the tests in another terminal (PORTAL_TESTS_CONFIG has to be set):

```
source catkin/devel/setup.bash
cd tests  # so that py.test discovers only selenium unit tests
py.test -s -k test_ros  # run all cases with 'test_ros' prefix (should be all ROS tests)
```


#### Catkin ROS tests

Remove cmakelists with possibly wrong paths:

```
cd catkin/src
rm CMakeLists.txt
```

Source the goodness to have all catkin stuff in PATH
(note: already mentioned above, really necessary again?)

```
source /opt/ros/indigo/setup.bash
```

Re-init the workspace by creating CMakeLists.txt

```
catkin_init_workspace
```
Build

```
cd ../
catkin_make
```
Run tests

```
catkin_make run_tests
```



#### Selenium tests documentation

For generating documentation about tests modules, classes and test cases, we use
the sphinx tool. The document skeleton files are defined and up-to-date documentation is
generated by a single script execution. Both *PDF* and *HTML* formats are produced. 

Start in the project root directory: 

```
source catkin/devel/setup.bash
cd tests/doc
./run-sphinx.sh
```

The resulting single file *HTML* and *PDF* documents are located as follows:

- `tests/doc/build/singlehtml/index.html`
- `tests/doc/build/latex/PortalSeleniumTests.pdf`
